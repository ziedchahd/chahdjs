import{n as D,i as o,a as u,T as P,f as _,I as L,g as S,A as y,F as K,t as $,Q as re,c as H,r as le,b as ie,a5 as ae,Y as X,R as F,u as se,h as ce,s as ue,j as oe}from"./index-00bf0c33.js";import{B as de}from"./index-345cd19e.js";import{P as fe}from"./index-812a7a1f.js";function me(e,a,f){const s=`fail to post ${e} ${f.status}'`,c=new Error(s);return c.status=f.status,c.method="post",c.url=e,c}function G(e){const a=e.responseText||e.response;if(!a)return a;try{return JSON.parse(a)}catch{return a}}function J(e){if(typeof XMLHttpRequest>"u")return;const a=new XMLHttpRequest,f=e.action;a.upload&&(a.upload.onprogress=function(d){d.total>0&&(d.percent=d.loaded/d.total*100),e.onProgress(d)});const s=new FormData;e.data&&Object.keys(e.data).map(l=>{s.append(l,e.data[l])}),s.append(e.filename,e.file),a.onerror=function(d){e.onError(d)},a.onload=function(){if(a.status<200||a.status>=300)return e.onError(me(f,e,a),G(a));e.onSuccess(G(a))},a.open("post",f,!0),e.withCredentials&&"withCredentials"in a&&(a.withCredentials=!0);const c=e.headers||{};for(let l in c)c.hasOwnProperty(l)&&c[l]!==null&&a.setRequestHeader(l,c[l]);a.send(s)}const ve=$('<div class="cm-upload-list-title">'),ge=$('<ul class="cm-upload-list"><div class="cm-upload-files">'),he=$('<img class="cm-upload-file-preview-img" alt="">'),$e=$('<div class="cm-upload-error">'),we=$('<li class="cm-upload-file-card"><div class="cm-upload-file-preview"></div><div class="cm-upload-file-card-body"><div class="cm-upload-file-card-info"><span class="cm-upload-file-card-info-name"></span><span></span></div></div><div class="cm-upload-file-control">');function _e(e){const a=s=>{const c=s.name.split(".").pop().toLocaleLowerCase()||"";let l="file-text";return["gif","jpg","jpeg","png","bmp","webp"].indexOf(c)>-1&&(l="image"),["mp4","m3u8","rmvb","avi","swf","3gp","mkv","flv"].indexOf(c)>-1&&(l="film1"),["mp3","wav","wma","ogg","aac","flac"].indexOf(c)>-1&&(l="music"),l},f=s=>{if(s<1024)return s+"B";if(s<1048576)return Math.round(s/1024*10)/10+"KB";if(s<1073741824)return Math.round(s/1024/1024*10)/10+"MB";if(s<1099511627776)return Math.round(s/1024/1024/1024*10)/10+"GB"};return(()=>{const s=ge(),c=s.firstChild;return o(s,u(_,{get when(){return e.files&&e.files.length},get children(){const l=ve();return o(l,u(P,{type:"secondary",children:"已上传文件"}),null),o(l,u(P,{type:"primary",class:"cm-upload-clear",get onClick(){return e.onClear},children:"清空"}),null),l}}),c),o(c,u(K,{get each(){return e.files},children:l=>(()=>{const d=we(),h=d.firstChild,m=h.nextSibling,v=m.firstChild,w=v.firstChild,C=w.nextSibling,k=m.nextSibling;return o(h,u(_,{get when(){return l.url},get fallback(){return u(L,{get name(){return a(l)},size:20})},get children(){const g=he();return g.$$click=()=>{e.onPreview&&e.onPreview(l)},S(()=>y(g,"src",l.url)),g}})),o(w,()=>l.name),o(C,()=>f(l.size)),o(m,u(_,{get when(){return l.showProgress&&l.percentage!==100},get children(){return u(fe,{strokeWidth:4,get value(){return l.percentage},hidePercent:!0})}}),null),o(m,u(_,{get when(){return l.status==="fail"},get children(){const g=$e();return o(g,u(L,{name:"alert-circle",size:12}),null),o(g,u(P,{type:"error",size:"small",class:"cm-upload-error-text",children:"上传失败"}),null),o(g,u(P,{type:"primary",class:"cm-upload-retry",size:"small",onClick:()=>{e.onRetry&&e.onRetry(l)},children:"重试"}),null),g}}),null),o(k,u(de,{size:"small",ghost:!0,get icon(){return u(L,{name:"x"})},onClick:()=>{e.onRemove&&e.onRemove(l)}})),S(()=>y(w,"title",l.name)),d})()})),s})()}D(["click"]);const Le=$('<ul class="cm-upload-list cm-upload-picture-list"><li class="cm-upload-picture-add">'),ye=$('<li class="cm-upload-picture-card"><img class="cm-upload-picture-img" alt=""><div class="cm-upload-picture-remove"></div><div class="cm-upload-picture-preview">');function Ce(e){return(()=>{const a=Le(),f=a.firstChild;return o(a,u(K,{get each(){return e.files},children:s=>(()=>{const c=ye(),l=c.firstChild,d=l.nextSibling,h=d.nextSibling;return d.$$click=()=>{e.onRemove&&e.onRemove(s)},o(d,u(L,{name:"x-circle"})),h.$$click=()=>{e.onPreview&&e.onPreview(s)},o(h,u(L,{name:"eye",size:20})),S(()=>y(l,"src",s.url)),c})()}),f),re(f,"click",e.onClick,!0),o(f,()=>e.children),a})()}D(["click"]);const Ee=$('<div class="cm-upload-out">'),be=$('<div><input class="cm-upload-input" type="file">');function xe(e){const[a,f]=H(!1),[s,c]=H(!1),l=e.format??[],d=[],h=e.type??"select",[m,v]=le({fileList:d,previewUrl:""});let w={};const C=e.name??"file",k=()=>oe(e,"cm-upload",{"cm-upload-select":h==="select","cm-upload-drag":h==="drag","cm-upload-dragOver":h==="drag"&&a()});ie(()=>{if(e.defaultFileList){const t=e.defaultFileList.map(n=>(n.uid||(n.uid=X()),n));v("fileList",t)}});const g=t=>{const n=t.target.files;n&&(x(n),b.value=null)},x=t=>{let n=Array.prototype.slice.call(t);e.multiple||(n=n.slice(0,1)),n.length!==0&&n.forEach(i=>{N(i)})},N=t=>{if(!e.beforeUpload)return E(t);const n=e.beforeUpload(t);n&&n.then?n.then(i=>{Object.prototype.toString.call(i)==="[object File]"?E(i):E(t)},()=>{}):n!==!1&&E(t)},E=t=>{if(l.length){const n=t.name.split(".").pop().toLocaleLowerCase();if(!l.some(r=>r.toLocaleLowerCase()===n))return e.onFormatError&&e.onFormatError(t,d),!1}if(e.maxSize&&t.size>e.maxSize*1024)return e.onExceededSize&&e.onExceededSize(t,d),!1;Q(t),J({headers:e.headers,withCredentials:e.withCredentials,file:t,data:e.data,filename:C,action:e.action,onProgress:n=>{O(n,t)},onSuccess:n=>{U(n,t)},onError:(n,i)=>{z(n,i,t)}})},Q=t=>{t.uid=X(),w[t.uid]=t;const n={status:"uploading",name:t.name,size:t.size,percentage:0,uid:t.uid,showProgress:!0};v("fileList",[...m.fileList,n])},R=t=>{const n=m.fileList;let i;return n.every(r=>(i=t.uid===r.uid?r:null,!i)),i},O=(t,n)=>{const i=R(n);e.onProgress&&e.onProgress(t,i,m.fileList),v("fileList",r=>r.uid===n.uid,"percentage",t.percent||0)},U=(t,n)=>{const i=R(n);i&&(v("fileList",r=>r.uid===n.uid,F(r=>{r.status="finished",r.response=t,r.url=e.getFileUrl&&e.getFileUrl(t,r)})),e.onSuccess&&e.onSuccess(t,i,m.fileList),setTimeout(()=>{v("fileList",r=>r.uid===n.uid,F(r=>{r.showProgress=!1}))},1e3))},z=(t,n,i)=>{R(i),v("fileList",r=>r.uid===i.uid,"status","fail"),e.onError&&e.onError(t,n,i)},B=t=>{v("fileList",F(n=>{n.splice(n.indexOf(t),1)})),delete w[t.uid],e.onRemove&&e.onRemove(t,m.fileList)},A=t=>{t.status==="finished"&&(v("previewUrl",t.url),c(!0),e.onPreview&&e.onPreview(t))},M=()=>{m.fileList.forEach(t=>{e.onRemove&&e.onRemove(t,m.fileList)}),w={},v("fileList",[])},T=()=>{e.disabled||b.click()},V=t=>{const n=w[t.uid];n&&J({headers:e.headers,withCredentials:e.withCredentials,file:n,data:e.data,filename:C,action:e.action,onProgress:i=>{O(i,n)},onSuccess:i=>{U(i,n)},onError:(i,r)=>{z(i,r,n)}})},W=t=>{t.preventDefault&&t.preventDefault(),f(!1),!e.disabled&&x(t.dataTransfer.files)},Y=t=>{e.disabled||e.paste&&x(t.clipboardData.files)},p=t=>{t.preventDefault&&t.preventDefault(),f(!0)},Z=t=>{t.preventDefault&&t.preventDefault(),f(!1)},ee=()=>m.fileList.map(t=>({...t}));let b;return e.ref&&e.ref({clearFiles:M,getFileList:ee}),(()=>{const t=be(),n=t.firstChild;n.addEventListener("change",g);const i=b;return typeof i=="function"?se(i,n):b=n,o(t,u(_,{get when(){return e.listType==="picture"},get children(){return u(Ce,{get files(){return m.fileList},onRemove:B,onPreview:A,onClick:T,get children(){return e.children}})}}),null),o(t,u(_,{get when(){return e.listType!=="picture"},get children(){return[(()=>{const r=Ee();return r.addEventListener("dragleave",Z),r.addEventListener("dragover",p),r.addEventListener("paste",Y),r.addEventListener("drop",W),r.$$click=T,o(r,()=>e.children),r})(),u(_e,{get files(){return m.fileList},onRemove:B,onPreview:A,onClear:M,onRetry:V})]}}),null),o(t,u(ae,{get previewList(){return[m.previewUrl]},visible:[s,c]}),null),S(r=>{const te=k(),ne=e.style,j=e.multiple,q=e.webkitdirectory,I=e.accept;return r._v$=ce(t,te,r._v$),r._v$2=ue(t,ne,r._v$2),j!==r._v$3&&(n.multiple=r._v$3=j),q!==r._v$4&&y(n,"webkitdirectory",r._v$4=q),I!==r._v$5&&y(n,"accept",r._v$5=I),r},{_v$:void 0,_v$2:void 0,_v$3:void 0,_v$4:void 0,_v$5:void 0}),t})()}D(["click"]);export{xe as U};
